!function(){"use strict";function t(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var i=function(){function t(t,i){for(var e=0;e<i.length;e++){var r=i[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(i,e,r){return e&&t(i.prototype,e),r&&t(i,r),i}}(),e=function(){function e(i,r){t(this,e),this.id=r,this._type=i,this._attributes=[],this._relationships=[],this._references=[],this._protectedAttributes={},this._protectedRelationships={}}return i(e,[{key:"serialize",value:function(t){var i=this,e={data:{type:this._type}};return t=t||{},t.attributes=t.attributes||this._attributes,t.relationships=t.relationships||this._relationships,void 0!==this.id&&(e.data.id=this.id),0!==t.attributes.length&&(e.data.attributes={}),0!==t.relationships.length&&(e.data.relationships={}),t.attributes.forEach(function(t){e.data.attributes[t]=i[t]}),t.relationships.forEach(function(t){function r(t){return{type:t._type,id:t.id}}i[t]?i[t].constructor===Array?e.data.relationships[t]={data:i[t].map(r)}:e.data.relationships[t]={data:r(i[t])}:e.data.relationships[t]={data:null}}),e}},{key:"serializeGeneric",value:function(t){var i=this,e={};return t=t||{},t.attributes=t.attributes||this._attributes,t.relationships=t.relationships||this._relationships,void 0!==this.id&&(e.id=this.id),0!==t.attributes.length&&(e.attributes={}),0!==t.relationships.length&&(e.relationships={}),t.attributes.forEach(function(t){e.attributes[t]=i[t]}),t.relationships.forEach(function(t){function r(t){return+t.id}i[t].constructor===Array?e.relationships[t]=i[t].map(r):e.attributes[t+"Id"]=+r(i[t])}),e}},{key:"setAttribute",value:function(t,i){void 0===this[t]&&this._attributes.push(t),this[t]=i,this._protectedAttributes[t]=i}},{key:"setRelationship",value:function(t,i){void 0===this[t]&&this._relationships.push(t),this[t]=i,this._protectedRelationships[t]=i}},{key:"restoreAttributes",value:function(){var t=this;t._protectedAttributes.forEach(function(i,e){t._attributes[e]=i})}}]),e}(),r=function(){function r(){t(this,r),this.graph={}}return i(r,[{key:"destroy",value:function(t){var i=this;this.graph[t._type][t.id]._references.map(function(r){i.graph[r.type][r.id][r.relation].constructor===Array?i.graph[r.type][r.id][r.relation].forEach(function(e,a){e.id===t.id&&i.graph[r.type][r.id][r.relation].splice(a,1)}):i.graph[r.type][r.id][r.relation].id===t.id&&(i.graph[r.type][r.id][r.relation]=new e(i.graph[r.type][r.id][r.relation]._type))}),delete i.graph[t._type][t.id]}},{key:"find",value:function(t,i){return this.graph[t]&&this.graph[t][i]?this.graph[t][i]:null}},{key:"findAll",value:function(t){var i=this;return this.graph[t]?Object.keys(i.graph[t]).map(function(e){return i.graph[t][e]}):[]}},{key:"reset",value:function(){this.graph={}}},{key:"initModel",value:function(t,i){return this.graph[t]=this.graph[t]||{},this.graph[t][i]=this.graph[t][i]||new e(t,i),this.graph[t][i]}},{key:"syncRecord",value:function(t){function i(t){if(!r.find(t.type,t.id)){var i=r.initModel(t.type,t.id);i._placeHolder=!0}return r.graph[t.type][t.id]}var e,r=this,a=this.initModel(t.type,t.id);delete a._placeHolder;for(e in t.attributes)-1===a._attributes.indexOf(e)&&a._attributes.push(e),a[e]=t.attributes[e],a._protectedAttributes[e]=t.attributes[e];if(t.links&&(a._links=t.links),t.relationships)for(e in t.relationships){var n=t.relationships[e];if(void 0!==n.data)if(a._relationships.push(e),null===n.data)a[e]=null;else if(n.data.constructor===Array){a[e]=n.data.map(i),a[e]=[];for(var s in n.data){var o=i(n.data[s]);o._references.push({id:a.id,type:a._type,relation:e}),a[e].push(o)}}else{var h=i(n.data);h._references.push({id:a.id,type:a._type,relation:e}),a[e]=h,a._protectedRelationships[e]=r.initModel(n.data.type,n.data.id)}n.links&&(a._relationship_links=a._relationship_links||{},a._relationship_links[e]=n.links)}return a}},{key:"syncWithMeta",value:function(t){var i=t.data,e=this.syncRecord.bind(this);return i?(t.included&&t.included.map(e),{data:i.constructor===Array?i.map(e):e(i),meta:"meta"in t?t.meta:null}):[]}},{key:"sync",value:function(t){return this.syncWithMeta(t).data}}]),r}();"undefined"!=typeof module&&(module.exports={JsonApiDataStore:r,JsonApiDataStoreModel:e}),exports.JsonApiDataStore=r,exports.JsonApiDataStoreModel=e}();
"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,i,a){return i&&t(e.prototype,i),a&&t(e,a),e}}(),JsonApiDataStoreModel=function(){function t(e,i){_classCallCheck(this,t),this.id=i,this._type=e,this._attributes=[],this._relationships=[],this._references=[],this._protectedAttributes={},this._protectedRelationships={}}return _createClass(t,[{key:"serialize",value:function(t){function e(t){return{type:t._type,id:t.id}}var i=this,a={data:{type:this._type}};return t=t||{},t.attributes=t.attributes||this._attributes,t.relationships=t.relationships||this._relationships,void 0!==this.id&&(a.data.id=this.id),0!==t.attributes.length&&(a.data.attributes={}),0!==t.relationships.length&&(a.data.relationships={}),t.attributes.forEach(function(t){a.data.attributes[t]=i[t]}),t.relationships.forEach(function(t){i[t]?i[t].constructor===Array?a.data.relationships[t]={data:i[t].map(e)}:a.data.relationships[t]={data:e(i[t])}:a.data.relationships[t]={data:null}}),a}},{key:"setAttribute",value:function(t,e){void 0===this[t]&&this._attributes.push(t),this[t]=e,this._protectedAttributes[t]=e}},{key:"setRelationship",value:function(t,e){void 0===this[t]&&this._relationships.push(t),this[t]=e,this._protectedRelationships[t]=e}}]),t}(),JsonApiDataStore=function(){function t(){_classCallCheck(this,t),this.graph={}}return _createClass(t,[{key:"destroy",value:function(t){var e=this;t._references.map(function(i){var a=e.graph[i.type][i.id],r=a[i.relation];r===t?a.setRelationship(i.relation,null):r.constructor===Array&&(e.graph[i.type][i.id][i.relation]=r.filter(function(e){return e!==t}))}),delete e.graph[t._type][t.id]}},{key:"find",value:function(t,e){return this.graph[t]&&this.graph[t][e]?this.graph[t][e]:null}},{key:"findAll",value:function(t){var e=this;return this.graph[t]?Object.keys(e.graph[t]).map(function(i){return e.graph[t][i]}):[]}},{key:"reset",value:function(){this.graph={}}},{key:"initModel",value:function(t,e){return this.graph[t]=this.graph[t]||{},this.graph[t][e]=this.graph[t][e]||new JsonApiDataStoreModel(t,e),this.graph[t][e]}},{key:"syncRecord",value:function(t){function e(t){if(!r.find(t.type,t.id)){var e=r.initModel(t.type,t.id);e._placeHolder=!0}return r.graph[t.type][t.id]}function i(t){return new JsonApiDataStoreModel(t.type,t.id)}var a,r=this,n=this.initModel(t.type,t.id);delete n._placeHolder;for(a in t.attributes)-1===n._attributes.indexOf(a)&&n._attributes.push(a),n[a]=t.attributes[a],n._protectedAttributes[a]=t.attributes[a];if(t.links&&(n._links=t.links),t.relationships)for(a in t.relationships){var s,o=t.relationships[a];void 0!==o.data&&(n._relationships.push(a),null===o.data?(n[a]=null,n._protectedRelationships[a]=null):o.data.constructor===Array?(n[a]=[],n._protectedRelationships[a]=[],o.data.forEach(function(t,r){s=e(t),s._references.push({id:n.id,type:n._type,relation:a}),n[a].push(s),n._protectedRelationships[a].push(i(t))})):(s=e(o.data),s._references.push({id:n.id,type:n._type,relation:a}),n[a]=s,n._protectedRelationships[a]=i(o.data))),o.links&&(n._relationship_links=n._relationship_links||{},n._relationship_links[a]=o.links)}return n}},{key:"syncWithMeta",value:function(t){var e=t.data,i=this.syncRecord.bind(this);return e?(t.included&&t.included.map(i),{data:e.constructor===Array?e.map(i):i(e),meta:"meta"in t?t.meta:null}):[]}},{key:"sync",value:function(t){return this.syncWithMeta(t).data}}]),t}();"undefined"!=typeof module&&(module.exports={JsonApiDataStore:JsonApiDataStore,JsonApiDataStoreModel:JsonApiDataStoreModel});